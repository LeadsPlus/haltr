<?xml version="1.0" encoding="UTF-8"?>
<facturae:Facturae xmlns:facturae="http://www.facturae.es/Facturae/2009/v3.2/Facturae"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://www.facturae.es/Facturae/2009/v3.2/Facturae http://www.facturae.es/NR/rdonlyres/2DF1A921-9E57-4A24-85D8-14FE74E0FB31/0/Facturaev3_2.xsd">
   <FileHeader>
      <SchemaVersion>3.2</SchemaVersion>        <!-- fixe -->
      <Modality>I</Modality>                    <!-- fixe I = Individual -->
      <InvoiceIssuerType>TE</InvoiceIssuerType> <!-- fixe TE = Emesa i signada per la tercera part (invinet) -->
      <ThirdParty>                              <!-- fixe Invinet signa en nom de l'empresa... -->
         <TaxIdentification>
            <PersonTypeCode>J</PersonTypeCode>
            <ResidenceTypeCode>R</ResidenceTypeCode>
            <TaxIdentificationNumber>B63276174</TaxIdentificationNumber>
         </TaxIdentification>
         <LegalEntity>
            <CorporateName>Invinet Sistemes 2003, S.L</CorporateName>
            <AddressInSpain>
               <Address>Ribes 31</Address>
               <PostCode>08013</PostCode>
               <Town>Barcelona</Town>
               <Province>Barcelona</Province>
               <CountryCode>ESP</CountryCode>
            </AddressInSpain>
         </LegalEntity>
      </ThirdParty>
      <Batch>
         <BatchIdentifier><%= @invoice.batchidentifier %></BatchIdentifier>  <!-- generar un id en base a la data factura i número de factura -->
         <InvoicesCount>1</InvoicesCount>    <!-- fixe 1 factura per document -->
         <TotalInvoicesAmount>
            <TotalAmount>63.72</TotalAmount>
         </TotalInvoicesAmount>
         <TotalOutstandingAmount>
            <TotalAmount>63.72</TotalAmount>
         </TotalOutstandingAmount>
         <TotalExecutableAmount>
            <TotalAmount>63.72</TotalAmount>
         </TotalExecutableAmount>
         <InvoiceCurrencyCode><%= @invoice.currency %></InvoiceCurrencyCode>  <!-- moneda de la factura -->
      </Batch>
   </FileHeader>
   <Parties>
      <SellerParty>
         <TaxIdentification>
            <PersonTypeCode><%= @invoice.persontypecode %></PersonTypeCode>     <!-- Si Empresa => J= Persona jurídica F = persona física (en cas que tingui IRPF a la fitxa de persona)-->
            <ResidenceTypeCode>R</ResidenceTypeCode>  <!-- fixe R=Residencia a España.  -->
            <TaxIdentificationNumber>B63354724</TaxIdentificationNumber>
         </TaxIdentification>
<% if @invoice.persontypecode == "J" -%>
         <!-- Si és una Empresa (no té IRPF a la fitxa de empresa  -->
         <LegalEntity>                             
            <CorporateName><%=@company.name%></CorporateName>
            <%= render :partial => "address.xml", :locals => {:entity => @company} %>
            <ContactDetails>
               <WebAddress><%=@company.website%></WebAddress>
               <ElectronicMail><%=@company.email%></ElectronicMail>
            </ContactDetails>
         </LegalEntity>
<% else -%>
         <!-- Si es té IRPF, es una persona física, cal omplir Individual enlloc de LegalEntity -->
         <Individual>
            <Name><%=@company.first_name%></Name>
            <FirstSurname><%=@company.last_name%></FirstSurname>
            <%= render :partial => "address.xml", :locals => {:entity => @company} %>
            <ContactDetails>
               <WebAddress><%=@company.website%></WebAddress>
               <ElectronicMail><%=@company.email%></ElectronicMail>
            </ContactDetails>
         </Individual>
<% end -%>
      </SellerParty>
      <BuyerParty>
         <TaxIdentification>
            <PersonTypeCode>J</PersonTypeCode>
            <ResidenceTypeCode>R</ResidenceTypeCode>
            <TaxIdentificationNumber><%=@client.taxcode%></TaxIdentificationNumber>
         </TaxIdentification>
         <LegalEntity>
            <CorporateName><%=@client.name%></CorporateName>
            <%= render :partial => "address.xml", :locals => {:entity => @client}%>
<% @client.people.each do |person| -%>
             <ContactDetails>
               <Telephone><%= person.phone %></Telephone>
               <ElectronicMail><%= person.email %></ElectronicMail>
               <ContactPersons><%= person.name %></ContactPersons>
             </ContactDetails>
<% end -%>
         </LegalEntity>
      </BuyerParty>
   </Parties>
   <Invoices>
      <Invoice>
         <InvoiceHeader>
            <InvoiceNumber><%=@invoice.number%></InvoiceNumber>
            <InvoiceDocumentType>FC</InvoiceDocumentType> <!-- fixe FC=Factura Comercial -->
            <InvoiceClass>OO</InvoiceClass>  <!-- fixe OO=Original -->
         </InvoiceHeader>
         <InvoiceIssueData>
            <IssueDate><%=@invoice.date%></IssueDate>
            <InvoiceCurrencyCode><%=@client.currency%></InvoiceCurrencyCode>     <!-- de la fitxa de client -->
            <TaxCurrencyCode><%=@client.currency%></TaxCurrencyCode>             <!-- la mateixa que la anterior -->
            <LanguageName><%=@client.language%></LanguageName>                    <!-- de la fitxa de client -->
         </InvoiceIssueData>
         <TaxesOutputs>
            <Tax>                                           <!-- convenim una sola línia d'impostos -->
               <TaxTypeCode>01</TaxTypeCode>                <!-- 01 = IVA -->
               <TaxRate><%=@invoice.tax_percent%></TaxRate>                     
               <TaxableBase>
                  <TotalAmount><%=@invoice.subtotal%></TotalAmount>
               </TaxableBase>
               <TaxAmount>
                 <TotalAmount><%=@invoice.tax%></TotalAmount>
               </TaxAmount>
            </Tax>
         </TaxesOutputs>
         <!-- En cas que sigui persona física, ha de poder informar de IRPF -->
<% if @invoice.persontypecode == "F" -%>
         <TaxesWithheld>
            <Tax>
               <TaxTypeCode>04</TaxTypeCode>  04 = IRPF
               <TaxRate><%=@company.withholding_tax_percent%></TaxRate>
               <TaxableBase>
                  <TotalAmount><%=@invoice.subtotal%></TotalAmount>
               </TaxableBase>
               <TaxAmount>
                 <TotalAmount><%=@invoice.withholding_tax%></TotalAmount>
               </TaxAmount>
            </Tax>
         </TaxesWithheld>
<% end -%>
         
         <InvoiceTotals>
            <TotalGrossAmount><%=@invoice.subtotal%></TotalGrossAmount>
            <TotalGrossAmountBeforeTaxes><%=@invoice.subtotal%></TotalGrossAmountBeforeTaxes>
            <TotalTaxOutputs><%=@invoice.tax%></TotalTaxOutputs>
            <TotalTaxesWithheld><%=@invoice.withholding_tax%></TotalTaxesWithheld>  <!-- encara que no n'hi hagi, s'ha de posar a 0.00 -->
            <InvoiceTotal><%=@invoice.total%></InvoiceTotal>
            <TotalOutstandingAmount><%=@invoice.total%></TotalOutstandingAmount>
            <TotalExecutableAmount><%=@invoice.total%></TotalExecutableAmount>
         </InvoiceTotals>
         <Items>
<% @invoice.invoice_lines.each do |invoice_line| -%>
            <InvoiceLine>
              <ReceiverTransactionReference><%=@invoice.number%></ReceiverTransactionReference>  <!-- número de comanda. Com que no hi ha nº comanda a nivell de capçalera, cal repetir-lo a totes les línies si hi es -->
               <ItemDescription><%=invoice_line.description%></ItemDescription>
               <Quantity><%=invoice_line.quantity%></Quantity>
               <UnitPriceWithoutTax><%=precision(invoice_line.price.dollars)%></UnitPriceWithoutTax>     <!-- ojo amb la precisió decimal, han de ser 6 dígits!! -->
               <TotalCost><%=precision(invoice_line.price.dollars*invoice_line.quantity)%></TotalCost>
               <GrossAmount><%=precision(invoice_line.price.dollars*invoice_line.quantity)%></GrossAmount>
               <TaxesOutputs>                                           <!-- s'han de repetir els impostos a nivell de línia. calcular-ho? -->
                  <Tax>
                     <TaxTypeCode>01</TaxTypeCode>
                     <TaxRate><%=@invoice.tax_percent%></TaxRate>
                     <TaxableBase>
                       <TotalAmount><%=precision(invoice_line.price.dollars*invoice_line.quantity)%></TotalAmount>
                     </TaxableBase>
                     <TaxAmount>
                        <TotalAmount><%=invoice_line.tax%></TotalAmount>
                     </TaxAmount>
                  </Tax>
               </TaxesOutputs>
            </InvoiceLine>
<% end -%>
         </Items>
         <PaymentDetails>
            <Installment>
              <InstallmentDueDate><%=@invoice.due_date%></InstallmentDueDate>
               <InstallmentAmount>63.72</InstallmentAmount>
               <PaymentMeans>02</PaymentMeans>  <!-- 02 - Rebut domiciliat,  04 -transferencia -->
               <!-- AccountToBeCredited>
                  <AccountNumber>Transferencia</AccountNumber>
                  </AccountToBeCredited -->
               <AccountToBeDebited>
                  <AccountNumber>2081 0082 ** ******5188</AccountNumber>
               </AccountToBeDebited>
            </Installment>
         </PaymentDetails>
         <AdditionalData>
            <InvoiceAdditionalInformation>Notes</InvoiceAdditionalInformation>
         </AdditionalData>
      </Invoice>
   </Invoices>
</facturae:Facturae>
